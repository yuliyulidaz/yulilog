<!DOCTYPE html>
<html lang="ko" class="h-full antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lumina Studio : 발췌 이미지</title>
    
    <!-- 폰트 로드 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@200;300;400;500;600&family=Noto+Sans+KR:wght@100;300;400;500;700&family=Nanum+Myeongjo:wght@400;700&family=Nanum+Gothic:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/earlyaccess/kopubbatang.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Pretendard Variable', 'Pretendard', '-apple-system', 'BlinkMacSystemFont', 'system-ui', 'Roboto', 'Helvetica Neue', 'Segoe UI', 'Apple SD Gothic Neo', 'Noto Sans KR', 'Malgun Gothic', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'sans-serif'],
                        serif: ['Noto Serif KR', 'serif'],
                    },
                    colors: {
                        brand: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                        },
                        dark: {
                            bg: '#0f0f11',
                            panel: '#18181b',
                            border: '#27272a'
                        }
                    }
                }
            }
        }
    </script>

    <!-- Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* Custom Styles for inputs that Tailwind doesn't cover easily */
        input[type="range"] {
            -webkit-appearance: none;
            background: transparent;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #3b82f6;
            margin-top: -6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            cursor: pointer;
        }
        input[type="range"]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #e2e8f0;
            border-radius: 2px;
        }
        .dark input[type="range"]::-webkit-slider-runnable-track {
            background: #3f3f46;
        }

        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .dark .glass-panel {
            background: rgba(24, 24, 27, 0.7);
        }
        
        .pattern-grid {
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .dark .pattern-grid {
            background-image: radial-gradient(#3f3f46 1px, transparent 1px);
        }
    </style>
</head>
<body class="h-full bg-slate-50 dark:bg-zinc-950 text-slate-900 dark:text-slate-100 transition-colors duration-300 overflow-hidden flex flex-col items-center justify-center">

    <!-- App Container (Centered on large screens) -->
    <div class="w-full h-full max-w-[1200px] mx-auto bg-white dark:bg-dark-panel shadow-2xl flex flex-col border-x border-slate-200 dark:border-zinc-800">
        
        <!-- Header -->
        <header class="h-14 border-b border-slate-200 dark:border-dark-border flex items-center justify-between px-4 lg:px-6 bg-white dark:bg-dark-panel z-20 flex-shrink-0">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-brand-600 rounded-lg flex items-center justify-center text-white font-bold text-lg shadow-lg shadow-brand-500/30">
                    <i class="ph ph-quotes"></i>
                </div>
                <!-- Title hidden on mobile to make room for buttons -->
                <h1 class="font-bold text-lg tracking-tight hidden md:block"><span class="hidden lg:inline">Lumina Studio : </span>발췌 이미지</h1>
            </div>
            
            <div class="flex items-center gap-2 md:gap-3">
                <!-- Mobile Only Actions (Header) -->
                <button onclick="copyImage()" class="md:hidden w-9 h-9 flex items-center justify-center text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full transition-colors" title="복사">
                    <i class="ph ph-copy text-xl"></i>
                </button>
                <button onclick="downloadImage()" class="md:hidden flex items-center justify-center px-3 py-1.5 bg-brand-600 text-white text-sm font-bold rounded-lg shadow-sm active:scale-95 transition-transform">
                    저장
                </button>

                <!-- Desktop Links -->
                <a href="https://yuliyulidaz.github.io/yulipage/" target="_blank" class="hidden md:flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-slate-600 dark:text-slate-400 hover:text-brand-600 dark:hover:text-brand-400 transition-colors rounded-md hover:bg-slate-50 dark:hover:bg-slate-800">
                    <i class="ph ph-file-text"></i> 내지 생성기
                </a>
                <button onclick="toggleDarkMode()" class="w-9 h-9 rounded-full flex items-center justify-center text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 transition-all dark-mode-toggle">
                    <i class="ph ph-moon text-xl"></i>
                </button>
            </div>
        </header>

        <!-- Main Workspace -->
        <main class="flex-1 flex flex-col md:flex-row overflow-hidden relative">
            
            <!-- Workspace (Preview) - Mobile: Top (Order 1), Desktop: Right (Order 2) -->
            <section class="order-1 md:order-2 w-full md:flex-1 h-[40vh] md:h-auto bg-slate-100 dark:bg-[#09090b] relative flex flex-col items-center justify-center p-4 md:p-8 lg:p-12 pattern-grid overflow-hidden flex-shrink-0 z-0 border-b md:border-b-0 border-slate-200 dark:border-zinc-800">
                
                <div class="relative w-full h-full flex items-center justify-center">
                     <!-- Canvas Wrapper -->
                    <div class="relative shadow-[0_20px_60px_-15px_rgba(0,0,0,0.2)] dark:shadow-[0_20px_60px_-15px_rgba(0,0,0,0.5)] transition-all duration-300 transform" id="canvasContainer">
                        <canvas id="canvas" width="1080" height="1080" class="max-w-full max-h-[35vh] md:max-h-[85vh] object-contain bg-white rounded-sm"></canvas>
                    </div>
                </div>

                <!-- Floating Action Bar - Desktop Only -->
                <div class="hidden md:flex absolute bottom-6 left-1/2 -translate-x-1/2 items-center gap-2 p-1.5 bg-white/90 dark:bg-zinc-800/90 backdrop-blur shadow-xl border border-slate-200 dark:border-zinc-700 rounded-2xl z-20">
                    <button onclick="downloadImage()" class="flex items-center gap-2 px-5 py-2.5 bg-brand-600 hover:bg-brand-700 text-white rounded-xl font-medium transition-transform active:scale-95 shadow-lg shadow-brand-500/20">
                        <i class="ph ph-download-simple text-lg"></i>
                        <span>저장</span>
                    </button>
                    <div class="w-px h-6 bg-slate-200 dark:bg-zinc-600 mx-1"></div>
                    <button onclick="copyImage()" class="p-2.5 text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-zinc-700 rounded-xl transition-colors" title="복사">
                        <i class="ph ph-copy text-xl"></i>
                    </button>
                </div>
                
            </section>

            <!-- Left Sidebar (Controls) - Mobile: Bottom (Order 2), Desktop: Left (Order 1) -->
            <aside class="order-2 md:order-1 w-full md:w-[400px] lg:w-[420px] bg-white dark:bg-dark-panel border-t md:border-t-0 md:border-r border-slate-200 dark:border-dark-border flex flex-col z-10 md:shadow-none relative flex-1 overflow-hidden" id="sidebar">
                
                <div class="h-full overflow-y-auto custom-scrollbar p-5 space-y-8 pb-10 md:pb-5">

                    <!-- Section: Canvas Settings -->
                    <section class="space-y-4">
                        <h2 class="text-xs font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider">캔버스 설정</h2>
                        
                        <div class="space-y-2">
                            <label class="text-xs font-medium text-slate-500">비율 선택</label>
                            <select id="canvasRatio" class="w-full appearance-none px-3 py-2.5 bg-slate-50 dark:bg-black/20 border border-slate-200 dark:border-slate-700 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-brand-500">
                                <option value="1:1">1:1 정방형 (1080x1080) - 인스타/트위터</option>
                                <option value="4:5">4:5 세로형 (1080x1350) - 인스타 포트레이트</option>
                                <option value="16:9">16:9 가로형 (1920x1080) - 유튜브/배경화면</option>
                            </select>
                        </div>
                    </section>

                    <hr class="border-slate-100 dark:border-slate-800">
                    
                    <!-- Section: Content -->
                    <section class="space-y-4">
                        <div class="flex items-center justify-between">
                            <h2 class="text-xs font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider">내용 입력</h2>
                            <button onclick="clearQuote()" class="text-xs text-red-500 hover:text-red-600 font-medium flex items-center gap-1">
                                <i class="ph ph-trash"></i> 내용 삭제
                            </button>
                        </div>
                        
                        <div class="relative group">
                            <textarea id="quote" placeholder="여기에 문구를 입력하세요..." class="w-full h-32 p-4 bg-slate-50 dark:bg-black/20 border border-slate-200 dark:border-slate-700 rounded-xl resize-none focus:outline-none focus:ring-2 focus:ring-brand-500/50 focus:border-brand-500 transition-all text-sm leading-relaxed placeholder:text-slate-400"></textarea>
                            <div class="absolute bottom-3 right-3 text-slate-400 pointer-events-none">
                                <i class="ph ph-pencil-simple"></i>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div class="space-y-1.5">
                                <label class="text-xs font-medium text-slate-500">제작자</label>
                                <input type="text" id="author" placeholder="제작자 (선택)" class="w-full px-3 py-2.5 bg-slate-50 dark:bg-black/20 border border-slate-200 dark:border-slate-700 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-brand-500/50 focus:border-brand-500 transition-all">
                            </div>
                            <div class="space-y-1.5">
                                <label class="text-xs font-medium text-slate-500">캐릭터/제목</label>
                                <input type="text" id="title" placeholder="캐릭터/제목 (선택)" class="w-full px-3 py-2.5 bg-slate-50 dark:bg-black/20 border border-slate-200 dark:border-slate-700 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-brand-500/50 focus:border-brand-500 transition-all">
                            </div>
                        </div>
                    </section>

                    <hr class="border-slate-100 dark:border-slate-800">

                    <!-- Section: Typography -->
                    <section class="space-y-4">
                        <h2 class="text-xs font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider">텍스트 스타일</h2>
                        
                        <!-- Font Family -->
                        <div class="space-y-1.5">
                             <div class="relative">
                                <select id="fontSelect" class="w-full appearance-none pl-3 pr-10 py-2.5 bg-slate-50 dark:bg-black/20 border border-slate-200 dark:border-slate-700 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-brand-500 transition-all cursor-pointer">
                                    <option value="Noto Serif KR">Noto Serif KR (명조)</option>
                                    <option value="KoPub Batang">KoPub 바탕 (독서용 명조)</option>
                                    <option value="Nanum Myeongjo">나눔명조</option>
                                    <option value="Pretendard">Pretendard (모던 고딕)</option>
                                    <option value="Noto Sans KR">Noto Sans KR (고딕)</option>
                                    <option value="Nanum Gothic">나눔고딕</option>
                                </select>
                                <div class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none">
                                    <i class="ph ph-caret-down"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Alignment & Break -->
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-slate-50 dark:bg-black/20 p-1 rounded-lg flex border border-slate-200 dark:border-slate-700">
                                <!-- Radio Group for Align -->
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="align" value="left" class="peer hidden" id="align-left">
                                    <div class="w-full h-8 flex items-center justify-center rounded text-slate-400 peer-checked:bg-white dark:peer-checked:bg-slate-700 peer-checked:text-brand-600 peer-checked:shadow-sm transition-all">
                                        <i class="ph ph-text-align-left text-lg"></i>
                                    </div>
                                </label>
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="align" value="center" class="peer hidden" id="align-center">
                                    <div class="w-full h-8 flex items-center justify-center rounded text-slate-400 peer-checked:bg-white dark:peer-checked:bg-slate-700 peer-checked:text-brand-600 peer-checked:shadow-sm transition-all">
                                        <i class="ph ph-text-align-center text-lg"></i>
                                    </div>
                                </label>
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="align" value="right" class="peer hidden" id="align-right">
                                    <div class="w-full h-8 flex items-center justify-center rounded text-slate-400 peer-checked:bg-white dark:peer-checked:bg-slate-700 peer-checked:text-brand-600 peer-checked:shadow-sm transition-all">
                                        <i class="ph ph-text-align-right text-lg"></i>
                                    </div>
                                </label>
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="align" value="justify" checked class="peer hidden" id="align-justify">
                                    <div class="w-full h-8 flex items-center justify-center rounded text-slate-400 peer-checked:bg-white dark:peer-checked:bg-slate-700 peer-checked:text-brand-600 peer-checked:shadow-sm transition-all">
                                        <i class="ph ph-text-align-justify text-lg"></i>
                                    </div>
                                </label>
                            </div>

                            <div class="bg-slate-50 dark:bg-black/20 p-1 rounded-lg flex border border-slate-200 dark:border-slate-700">
                                 <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="linebreak" value="char" checked class="peer hidden" id="linebreak-char">
                                    <div class="w-full h-8 flex items-center justify-center rounded text-xs font-medium text-slate-400 peer-checked:bg-white dark:peer-checked:bg-slate-700 peer-checked:text-brand-600 peer-checked:shadow-sm transition-all">
                                        글자
                                    </div>
                                </label>
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="linebreak" value="word" class="peer hidden" id="linebreak-word">
                                    <div class="w-full h-8 flex items-center justify-center rounded text-xs font-medium text-slate-400 peer-checked:bg-white dark:peer-checked:bg-slate-700 peer-checked:text-brand-600 peer-checked:shadow-sm transition-all">
                                        단어
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- Sliders -->
                        <div class="space-y-5 pt-2">
                            <div class="relative">
                                <div class="flex justify-between text-xs mb-2">
                                    <span class="text-slate-500">글자 크기</span>
                                    <span class="font-mono text-brand-600"><span id="fontSizeValue">42</span>px</span>
                                </div>
                                <input type="range" id="fontSize" min="30" max="80" value="42" class="w-full">
                            </div>
                            <div class="relative">
                                <div class="flex justify-between text-xs mb-2">
                                    <span class="text-slate-500">줄 간격</span>
                                    <span class="font-mono text-brand-600"><span id="lineHeightValue">1.5</span>x</span>
                                </div>
                                <input type="range" id="lineHeight" min="1.2" max="2.0" step="0.1" value="1.5" class="w-full">
                            </div>
                            <div class="relative">
                                <div class="flex justify-between text-xs mb-2">
                                    <span class="text-slate-500">여백</span>
                                    <span class="font-mono text-brand-600"><span id="paddingValue">100</span>px</span>
                                </div>
                                <input type="range" id="padding" min="50" max="200" step="10" value="100" class="w-full">
                            </div>
                        </div>
                    </section>

                    <hr class="border-slate-100 dark:border-slate-800">

                    <!-- Section: Style & Color -->
                    <section class="space-y-4">
                        <h2 class="text-xs font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider">배경 및 스타일</h2>
                        
                        <div class="space-y-4">
                            <!-- 1. Text Color -->
                            <div class="space-y-2">
                                <label class="text-xs font-medium text-slate-500">글자 색상</label>
                                <div class="relative w-full h-10 rounded-lg border border-slate-200 dark:border-slate-700 overflow-hidden shadow-sm">
                                    <input type="color" id="textColor" value="#ffffff" class="absolute -top-2 -left-2 w-[150%] h-[150%] cursor-pointer p-0 border-0">
                                </div>
                            </div>

                            <!-- 2. Background Color -->
                            <div class="space-y-3">
                                <div class="flex items-center justify-between">
                                    <label class="text-xs font-medium text-slate-500">배경 색상</label>
                                    <label class="inline-flex items-center cursor-pointer gap-2">
                                        <span class="text-xs text-slate-500">그라데이션</span>
                                        <input type="checkbox" id="useGradient" class="sr-only peer" checked>
                                        <div class="relative w-9 h-5 bg-slate-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-brand-300 dark:peer-focus:ring-brand-800 rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all dark:border-gray-600 peer-checked:bg-brand-600"></div>
                                    </label>
                                </div>
                                
                                <div class="flex gap-3">
                                    <!-- Main Color -->
                                    <div class="flex-1 space-y-1">
                                        <div class="relative w-full h-10 rounded-lg border border-slate-200 dark:border-slate-700 overflow-hidden shadow-sm">
                                            <input type="color" id="bgColorMain" value="#e0c3fc" class="absolute -top-2 -left-2 w-[150%] h-[150%] cursor-pointer p-0 border-0">
                                        </div>
                                        <div class="text-[10px] text-center text-slate-400">시작 / 단색</div>
                                    </div>
                                    
                                    <!-- Sub Color (Visible if Gradient) -->
                                    <div class="flex-1 space-y-1 transition-all duration-300" id="subColorContainer">
                                        <div class="relative w-full h-10 rounded-lg border border-slate-200 dark:border-slate-700 overflow-hidden shadow-sm">
                                            <input type="color" id="bgColorSub" value="#8ec5fc" class="absolute -top-2 -left-2 w-[150%] h-[150%] cursor-pointer p-0 border-0">
                                        </div>
                                        <div class="text-[10px] text-center text-slate-400">끝 색상</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 3. Color Presets -->
                        <div class="flex gap-2 overflow-x-auto no-scrollbar py-1">
                             <button onclick="applyPreset('#1a1a1a', '#1a1a1a', '#ffffff', false)" class="w-8 h-8 rounded-full bg-slate-900 border border-slate-200 shadow-sm flex-shrink-0" title="Dark Mode"></button>
                            <button onclick="applyPreset('#ffffff', '#ffffff', '#1a1a1a', false)" class="w-8 h-8 rounded-full bg-white border border-slate-200 shadow-sm flex-shrink-0" title="Light Mode"></button>
                            <button onclick="applyPreset('#f5f5f4', '#f5f5f4', '#44403c', false)" class="w-8 h-8 rounded-full bg-[#f5f5f4] border border-slate-200 shadow-sm flex-shrink-0" title="Stone"></button>
                            <button onclick="applyPreset('#fff1f2', '#fff1f2', '#881337', false)" class="w-8 h-8 rounded-full bg-[#fff1f2] border border-slate-200 shadow-sm flex-shrink-0" title="Rose"></button>
                             <button onclick="applyPreset('#fdf4ff', '#fdf4ff', '#701a75', false)" class="w-8 h-8 rounded-full bg-[#fdf4ff] border border-slate-200 shadow-sm flex-shrink-0" title="Fuchsia"></button>
                             <!-- Gradient Presets -->
                             <button onclick="applyPreset('#e0c3fc', '#8ec5fc', '#ffffff', true)" class="w-8 h-8 rounded-full bg-gradient-to-br from-[#e0c3fc] to-[#8ec5fc] border border-slate-200 shadow-sm flex-shrink-0" title="Dream"></button>
                             <button onclick="applyPreset('#ff9a9e', '#fecfef', '#ffffff', true)" class="w-8 h-8 rounded-full bg-gradient-to-br from-[#ff9a9e] to-[#fecfef] border border-slate-200 shadow-sm flex-shrink-0" title="Peach"></button>
                             <button onclick="applyPreset('#a18cd1', '#fbc2eb', '#ffffff', true)" class="w-8 h-8 rounded-full bg-gradient-to-br from-[#a18cd1] to-[#fbc2eb] border border-slate-200 shadow-sm flex-shrink-0" title="Lavender"></button>
                        </div>

                        <!-- 4. Background Image -->
                        <div class="pt-2">
                            <label class="flex items-center justify-center w-full h-24 border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-xl hover:border-brand-500 dark:hover:border-brand-500 hover:bg-slate-50 dark:hover:bg-slate-800 transition-all cursor-pointer group">
                                <div class="text-center">
                                    <div class="text-slate-400 group-hover:text-brand-500 transition-colors mb-1">
                                        <i class="ph ph-image text-2xl"></i>
                                    </div>
                                    <span class="text-xs text-slate-500 group-hover:text-slate-700 dark:group-hover:text-slate-300">배경 이미지 업로드</span>
                                </div>
                                <input type="file" id="bgImageUpload" accept="image/*" class="hidden">
                            </label>
                            
                            <div id="imageControlPanel" class="hidden mt-3 p-3 bg-slate-50 dark:bg-black/20 rounded-xl border border-slate-200 dark:border-slate-700 space-y-3">
                                <div class="flex justify-between items-center">
                                    <span id="imageFileName" class="text-xs text-slate-500 truncate max-w-[150px]"></span>
                                    <button id="btnImageDelete" onclick="deleteBackgroundImage()" class="text-xs text-red-500 hover:bg-red-50 p-1 rounded transition-colors"><i class="ph ph-trash"></i> 삭제</button>
                                </div>
                                
                                <!-- Image Controls -->
                                <div id="imageOptions" class="space-y-3">
                                    <div class="flex bg-white dark:bg-slate-800 rounded-lg p-1 border border-slate-200 dark:border-slate-700">
                                        <label class="flex-1 cursor-pointer text-center">
                                            <input type="radio" name="imageFit" value="cover" checked class="peer hidden" id="fit-cover">
                                            <span class="block text-xs py-1 rounded text-slate-500 peer-checked:bg-brand-50 peer-checked:text-brand-600 font-medium">채우기</span>
                                        </label>
                                        <label class="flex-1 cursor-pointer text-center">
                                            <input type="radio" name="imageFit" value="contain" class="peer hidden" id="fit-contain">
                                            <span class="block text-xs py-1 rounded text-slate-500 peer-checked:bg-brand-50 peer-checked:text-brand-600 font-medium">맞추기</span>
                                        </label>
                                    </div>
                                    
                                    <div class="grid grid-cols-3 gap-1 max-w-[120px] mx-auto">
                                        <!-- 3x3 Grid for Position -->
                                        <label class="aspect-square cursor-pointer"><input type="radio" name="imagePosition" value="top-left" class="peer hidden"><div class="w-full h-full border border-slate-200 rounded hover:bg-slate-100 peer-checked:bg-brand-500 peer-checked:border-brand-500"></div></label>
                                        <label class="aspect-square cursor-pointer"><input type="radio" name="imagePosition" value="top-center" class="peer hidden"><div class="w-full h-full border border-slate-200 rounded hover:bg-slate-100 peer-checked:bg-brand-500 peer-checked:border-brand-500"></div></label>
                                        <label class="aspect-square cursor-pointer"><input type="radio" name="imagePosition" value="top-right" class="peer hidden"><div class="w-full h-full border border-slate-200 rounded hover:bg-slate-100 peer-checked:bg-brand-500 peer-checked:border-brand-500"></div></label>
                                        
                                        <label class="aspect-square cursor-pointer"><input type="radio" name="imagePosition" value="middle-left" class="peer hidden"><div class="w-full h-full border border-slate-200 rounded hover:bg-slate-100 peer-checked:bg-brand-500 peer-checked:border-brand-500"></div></label>
                                        <label class="aspect-square cursor-pointer"><input type="radio" name="imagePosition" value="middle-center" checked class="peer hidden"><div class="w-full h-full border border-slate-200 rounded hover:bg-slate-100 peer-checked:bg-brand-500 peer-checked:border-brand-500"></div></label>
                                        <label class="aspect-square cursor-pointer"><input type="radio" name="imagePosition" value="middle-right" class="peer hidden"><div class="w-full h-full border border-slate-200 rounded hover:bg-slate-100 peer-checked:bg-brand-500 peer-checked:border-brand-500"></div></label>
                                        
                                        <label class="aspect-square cursor-pointer"><input type="radio" name="imagePosition" value="bottom-left" class="peer hidden"><div class="w-full h-full border border-slate-200 rounded hover:bg-slate-100 peer-checked:bg-brand-500 peer-checked:border-brand-500"></div></label>
                                        <label class="aspect-square cursor-pointer"><input type="radio" name="imagePosition" value="bottom-center" class="peer hidden"><div class="w-full h-full border border-slate-200 rounded hover:bg-slate-100 peer-checked:bg-brand-500 peer-checked:border-brand-500"></div></label>
                                        <label class="aspect-square cursor-pointer"><input type="radio" name="imagePosition" value="bottom-right" class="peer hidden"><div class="w-full h-full border border-slate-200 rounded hover:bg-slate-100 peer-checked:bg-brand-500 peer-checked:border-brand-500"></div></label>
                                    </div>
                                    
                                    <div class="relative pt-2">
                                         <div class="flex justify-between text-xs mb-1">
                                            <span class="text-slate-500">이미지 크기</span>
                                            <span class="font-mono text-brand-600"><span id="scaleValue">100</span>%</span>
                                        </div>
                                        <input type="range" id="bgImageScale" min="10" max="200" value="100" class="w-full">
                                    </div>

                                    <div class="relative">
                                         <div class="flex justify-between text-xs mb-1">
                                            <span class="text-slate-500">오버레이</span>
                                            <span class="font-mono text-brand-600" id="overlayValueText">원본</span>
                                        </div>
                                        <input type="range" id="overlayOpacity" min="-80" max="80" value="0" class="w-full">
                                        <div class="flex justify-between text-[10px] text-slate-400 mt-1 px-1">
                                            <span>밝게</span>
                                            <span>원본</span>
                                            <span>어둡게</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <hr class="border-slate-100 dark:border-slate-800">

                    <!-- Section: Logo Settings -->
                    <section class="space-y-4">
                        <h2 class="text-xs font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider">로고 설정</h2>
                        
                         <div class="space-y-2">
                            <label class="text-xs font-medium text-slate-500">플랫폼 로고</label>
                            <select id="platformSelect" class="w-full appearance-none px-3 py-2.5 bg-slate-50 dark:bg-black/20 border border-slate-200 dark:border-slate-700 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-brand-500">
                                <option value="">선택 안함</option>
                                <option value="dokiChat">도키챗</option>
                                <option value="luvDuv">러비더비</option>
                                <option value="reppley">레플리</option>
                                <option value="rplay">로맨틱플레이</option>
                                <option value="ropanAI">로판AI</option>
                                <option value="melting">멜팅</option>
                                <option value="bloom">블룸</option>
                                <option value="inkChat">잉크챗</option>
                                <option value="zeta">제타</option>
                                <option value="carat">캐럿</option>
                                <option value="chemi">케밍</option>
                                <option value="caveDuck">케이브덕</option>
                                <option value="crack">크랙</option>
                                <option value="pulse">펄스</option>
                                <option value="Fizzchat">피즈챗</option>
                                <option value="whif">WHIF</option> 
                            </select>
                        </div>

                        <div class="space-y-1">
                             <div class="flex justify-between text-xs mb-1">
                                <span class="text-slate-500">로고 크기</span>
                                <span class="font-mono text-brand-600"><span id="logoSizeValue">100</span>px</span>
                            </div>
                            <input type="range" id="logoSize" min="50" max="200" step="10" value="100" class="w-full">
                        </div>
                    </section>
                    
                    <div class="h-8"></div>
                </div>
                
            </aside>

        </main>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-24 left-1/2 -translate-x-1/2 px-6 py-3 bg-zinc-900/90 text-white rounded-full shadow-2xl backdrop-blur text-sm font-medium opacity-0 transition-opacity duration-300 pointer-events-none z-50 flex items-center gap-2">
        <i class="ph ph-check-circle text-brand-400 text-lg"></i>
        <span id="toastMessage">알림 메시지</span>
    </div>

    <script>
        // === Core Logic Preserved & Connected to New UI ===

        const platformLogos = {
            bloom: 'https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/bloom.jpg',
            carat: 'https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/carat.png',
            caveDuck: 'https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/Caveduck.jpg',  
    	    dokiChat: 'https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/dokichat.jpg',
            inkChat: 'https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/inkchat.jpg',
            zeta: 'https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/zeta.jpg',
            luvDuv: 'https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/LoveyDovey.jpg',
            melting: 'https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/melting.jpg',
            pulse: 'https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/pulse.jpg',
            ropanAI: 'https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/rofan.png',
            crack: 'https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/crack.png',
            whif: 'https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/whif.jpg',
            chemi: 'https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/chemi.png',
            Fizzchat: 'https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/Fizzchat.png',
            reppley: 'https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/reppley.jpg',
            rplay: 'https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/rplay.png'
        };
        
        let logoImages = {};
        let fontsLoaded = false;
        let backgroundImage = null;
        
        // Removed Mobile Sidebar Toggle Logic

        function showToast(message) {
            const toast = document.getElementById('toast');
            const toastMsg = document.getElementById('toastMessage');
            toastMsg.textContent = message;
            toast.classList.remove('opacity-0');
            
            setTimeout(() => {
                toast.classList.add('opacity-0');
            }, 2000);
        }
        
        async function preloadFonts() {
            try {
                const fontPromises = [
                    document.fonts.load('300 12px "Noto Serif KR"'),
                    document.fonts.load('300 12px "Noto Sans KR"'),
                    document.fonts.load('300 12px "Pretendard"'),
                    document.fonts.load('400 12px "KoPub Batang"'),
                    document.fonts.load('400 12px "Nanum Myeongjo"'),
                    document.fonts.load('400 12px "Nanum Gothic"')
                ];
                await Promise.all(fontPromises);
                fontsLoaded = true;
            } catch (error) {
                fontsLoaded = true; // Proceed anyway
            }
        }
        
        function preloadLogos() {
            Object.keys(platformLogos).forEach(key => {
                const img = new Image();
                img.src = platformLogos[key];
                img.crossOrigin = 'anonymous';
                logoImages[key] = img;
            });
        }
        
        // Background Gradient Switch Logic
        function toggleGradientUI() {
            const isGradient = document.getElementById('useGradient').checked;
            const subContainer = document.getElementById('subColorContainer');
            if (isGradient) {
                subContainer.classList.remove('opacity-50', 'pointer-events-none');
                subContainer.classList.remove('hidden');
            } else {
                subContainer.classList.add('opacity-50', 'pointer-events-none');
                subContainer.classList.add('hidden');
            }
            updateCanvas();
        }

        // Color Preset Helper
        function applyPreset(color1, color2, textColor, isGradient) {
            document.getElementById('bgColorMain').value = color1;
            document.getElementById('bgColorSub').value = color2;
            document.getElementById('textColor').value = textColor;
            // Removed textColorValue update since element is removed
            
            const checkbox = document.getElementById('useGradient');
            checkbox.checked = isGradient;
            
            toggleGradientUI();
        }

        // Image Handling
        document.getElementById('bgImageUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                showToast('이미지 파일만 업로드 가능합니다.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    backgroundImage = img;
                    document.getElementById('imageFileName').textContent = file.name;
                    document.getElementById('imageControlPanel').classList.remove('hidden');
                    updateCanvas();
                    showToast('이미지가 업로드되었습니다.');
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });
        
        function deleteBackgroundImage() {
            backgroundImage = null;
            document.getElementById('bgImageUpload').value = '';
            document.getElementById('imageFileName').textContent = '';
            document.getElementById('imageControlPanel').classList.add('hidden');
            updateCanvas();
            showToast('배경 이미지가 삭제되었습니다.');
        }
        
        function drawBackgroundImage(ctx, img, canvasWidth, canvasHeight, fit, position, scale) {
            const imgRatio = img.width / img.height;
            const canvasRatio = canvasWidth / canvasHeight;
            
            // Calculate base destination rect for fit/cover without scale
            let destX, destY, destWidth, destHeight;
            let sourceX = 0, sourceY = 0, sourceWidth = img.width, sourceHeight = img.height;

            if (fit === 'cover') {
                 // For cover, we map the source rect to the full canvas
                 // Apply scale: "Zoom in" means taking a smaller source area
                 
                 // 1. Calculate the ideal source rect to cover the canvas
                 if (imgRatio > canvasRatio) {
                    sourceHeight = img.height;
                    sourceWidth = img.height * canvasRatio;
                 } else {
                    sourceWidth = img.width;
                    sourceHeight = img.width / canvasRatio;
                 }
                 
                 // 2. Apply scale (Zoom)
                 // scale = 1.0 -> normal. scale = 1.5 -> zoom in (source gets smaller)
                 // However, user slider is 10-200%. 100% is normal.
                 // For cover, increasing scale usually means zooming IN.
                 // let's interpret scale: 1.0 = fit perfectly. > 1.0 = zoom in.
                 const zoom = scale;
                 sourceWidth /= zoom;
                 sourceHeight /= zoom;

                 // 3. Position the source rect within the image
                 if (position.includes('left')) sourceX = 0;
                 else if (position.includes('right')) sourceX = img.width - sourceWidth;
                 else sourceX = (img.width - sourceWidth) / 2;
                 
                 if (position.includes('top')) sourceY = 0;
                 else if (position.includes('bottom')) sourceY = img.height - sourceHeight;
                 else sourceY = (img.height - sourceHeight) / 2;

                 destX = 0; destY = 0;
                 destWidth = canvasWidth;
                 destHeight = canvasHeight;

            } else {
                // Contain
                // 1. Calculate base dest rect
                if (imgRatio > canvasRatio) {
                    destWidth = canvasWidth;
                    destHeight = canvasWidth / imgRatio;
                } else {
                    destHeight = canvasHeight;
                    destWidth = canvasHeight * imgRatio;
                }
                
                // 2. Apply Scale
                destWidth *= scale;
                destHeight *= scale;
                
                // 3. Position
                if (position.includes('left')) destX = 0;
                else if (position.includes('right')) destX = canvasWidth - destWidth;
                else destX = (canvasWidth - destWidth) / 2;
                
                if (position.includes('top')) destY = 0;
                else if (position.includes('bottom')) destY = canvasHeight - destHeight;
                else destY = (canvasHeight - destHeight) / 2;

                // For contain mode, we fill bg first
                fillBackground(ctx, canvasWidth, canvasHeight);
            }
            
            ctx.drawImage(img, sourceX, sourceY, sourceWidth, sourceHeight, destX, destY, destWidth, destHeight);
        }
        
        function fillBackground(ctx, width, height) {
            const isGradient = document.getElementById('useGradient').checked;
            const color1 = document.getElementById('bgColorMain').value;
            
            if (!isGradient) {
                ctx.fillStyle = color1;
                ctx.fillRect(0, 0, width, height);
            } else {
                const color2 = document.getElementById('bgColorSub').value;
                const gradient = ctx.createLinearGradient(0, 0, 0, height);
                gradient.addColorStop(0, color1);
                gradient.addColorStop(1, color2);
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, width, height);
            }
        }
        
        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            localStorage.setItem('darkMode', isDark);
            
            const icon = document.querySelector('.dark-mode-toggle i');
            if (isDark) {
                icon.classList.replace('ph-moon', 'ph-sun');
            } else {
                icon.classList.replace('ph-sun', 'ph-moon');
            }
        }
        
        // Initialize Dark Mode
        if (localStorage.getItem('darkMode') === 'true' || (!('darkMode' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
            document.querySelector('.dark-mode-toggle i').classList.replace('ph-moon', 'ph-sun');
        }

        function clearQuote() {
            if (confirm('모든 내용을 삭제하시겠습니까?')) {
                document.getElementById('quote').value = '';
                document.getElementById('author').value = '';
                document.getElementById('title').value = '';
                updateCanvas();
                showToast('내용이 삭제되었습니다.');
            }
        }
        
        async function updateCanvas() {
            if (!fontsLoaded) await preloadFonts();
            
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            
            const ratio = document.getElementById('canvasRatio').value;
            let width, height;
            switch(ratio) {
                case '1:1': width = 1080; height = 1080; break;
                case '4:5': width = 1080; height = 1350; break;
                case '16:9': width = 1920; height = 1080; break;
            }
            canvas.width = width;
            canvas.height = height;
            
            // Get Values
            const quote = document.getElementById('quote').value;
            const author = document.getElementById('author').value;
            const title = document.getElementById('title').value;
            const font = document.getElementById('fontSelect').value;
            
            const align = document.querySelector('input[name="align"]:checked').value;
            const linebreakMode = document.querySelector('input[name="linebreak"]:checked').value;
            
            const fontSize = parseInt(document.getElementById('fontSize').value);
            const lineHeightMultiplier = parseFloat(document.getElementById('lineHeight').value);
            const padding = parseInt(document.getElementById('padding').value);
            const textColor = document.getElementById('textColor').value;
            const platform = document.getElementById('platformSelect').value;
            const logoSize = parseInt(document.getElementById('logoSize').value);
            
            // Draw Background
            if (backgroundImage) {
                const imageFit = document.querySelector('input[name="imageFit"]:checked').value;
                const imagePosition = document.querySelector('input[name="imagePosition"]:checked').value;
                const overlayValue = parseInt(document.getElementById('overlayOpacity').value);
                const bgScale = parseInt(document.getElementById('bgImageScale').value) / 100;
                
                drawBackgroundImage(ctx, backgroundImage, width, height, imageFit, imagePosition, bgScale);
                
                if (overlayValue !== 0) {
                    if (overlayValue < 0) {
                         // White overlay
                        ctx.fillStyle = `rgba(255, 255, 255, ${Math.abs(overlayValue) / 100})`;
                    } else {
                        // Black overlay
                        ctx.fillStyle = `rgba(0, 0, 0, ${overlayValue / 100})`;
                    }
                    ctx.fillRect(0, 0, width, height);
                }
            } else {
                fillBackground(ctx, width, height);
            }
            
            // Draw Text
            const rgb = hexToRgb(textColor);
            ctx.fillStyle = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.95)`;
            
            let x;
            if (align === 'left' || align === 'justify') x = padding;
            else if (align === 'center') x = width / 2;
            else x = width - padding;
            
            ctx.font = `300 ${fontSize}px "${font}", "Noto Sans KR", sans-serif`;
            const maxWidth = width - (padding * 2);
            const lineHeight = fontSize * lineHeightMultiplier;
            let lines = [];
            
            const paragraphs = quote.split('\n');
            
            paragraphs.forEach(paragraph => {
                if (paragraph.trim() === '') {
                    lines.push('');
                    return;
                }
                
                if (linebreakMode === 'word') {
                    const words = paragraph.split(' ');
                    let currentLine = '';
                    
                    words.forEach(word => {
                        const testLine = currentLine + word + ' ';
                        const metrics = ctx.measureText(testLine);
                        if (metrics.width > maxWidth && currentLine !== '') {
                            lines.push(currentLine.trim());
                            currentLine = word + ' ';
                        } else {
                            currentLine = testLine;
                        }
                    });
                    if (currentLine.trim()) lines.push(currentLine.trim());
                } else {
                    let currentLine = '';
                    for (let i = 0; i < paragraph.length; i++) {
                        const char = paragraph[i];
                        const testLine = currentLine + char;
                        const metrics = ctx.measureText(testLine);
                        if (metrics.width > maxWidth && currentLine !== '') {
                            lines.push(currentLine);
                            currentLine = char;
                        } else {
                            currentLine = testLine;
                        }
                    }
                    if (currentLine) lines.push(currentLine);
                }
            });
            
            const totalHeight = lines.length * lineHeight;
            const bottomReserved = 90;
            let y = (height - totalHeight - bottomReserved) / 2 + fontSize;
            
            if (align === 'justify' && linebreakMode === 'word') {
                ctx.textAlign = 'left';
                lines.forEach((line, index) => {
                    if (line === '') {
                        y += lineHeight;
                        return;
                    }
                    if (index === lines.length - 1 || lines[index + 1] === '') {
                        ctx.fillText(line, padding, y);
                    } else {
                        drawJustifiedText(ctx, line, padding, y, maxWidth);
                    }
                    y += lineHeight;
                });
            } else {
                ctx.textAlign = align === 'justify' ? 'left' : align;
                let drawX = align === 'justify' ? padding : x;
                lines.forEach(line => {
                    if (line !== '') ctx.fillText(line, drawX, y);
                    y += lineHeight;
                });
            }
            
            // Draw Metadata (Author/Title)
            // Only draw if values exist
            if (author || title) {
                ctx.fillStyle = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.6)`;
                const bottomY = height - 130;
                const bottomX = padding;
                
                if (author && title) {
                    ctx.font = `300 38px "Nanum Gothic", "Noto Sans KR", sans-serif`;
                    ctx.textAlign = 'left';
                    ctx.fillText(`${author} | `, bottomX, bottomY);
                    const authorPartWidth = ctx.measureText(`${author} | `).width;
                    ctx.font = `600 38px "Nanum Gothic", "Noto Sans KR", sans-serif`;
                    ctx.fillText(`${title}`, bottomX + authorPartWidth, bottomY);
                } else if (author) {
                    ctx.font = `300 38px "Nanum Gothic", "Noto Sans KR", sans-serif`;
                    ctx.textAlign = 'left';
                    ctx.fillText(`${author}`, bottomX, bottomY);
                } else if (title) {
                    ctx.font = `600 38px "Nanum Gothic", "Noto Sans KR", sans-serif`;
                    ctx.textAlign = 'left';
                    ctx.fillText(`${title}`, bottomX, bottomY);
                }
            }
            
            // Draw Logo
            if (platform && logoImages[platform] && logoImages[platform].complete) {
                const logo = logoImages[platform];
                const logoX = width - 100 - logoSize;
                const logoY = height - 100 - logoSize;
                
                ctx.save();
                ctx.globalAlpha = 0.8;
                ctx.beginPath();
                ctx.arc(logoX + logoSize/2, logoY + logoSize/2, logoSize/2, 0, Math.PI * 2);
                ctx.closePath();
                ctx.clip();
                
                ctx.drawImage(logo, logoX, logoY, logoSize, logoSize);
                ctx.restore();
            }
        }
        
        function drawJustifiedText(ctx, text, x, y, maxWidth) {
            const words = text.split(' ');
            if (words.length === 1) {
                ctx.fillText(text, x, y);
                return;
            }
            const totalWidth = ctx.measureText(text).width;
            const spaceWidth = (maxWidth - totalWidth + (words.length - 1) * ctx.measureText(' ').width) / (words.length - 1);
            let currentX = x;
            words.forEach((word) => {
                ctx.fillText(word, currentX, y);
                currentX += ctx.measureText(word).width + spaceWidth;
            });
        }
        
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : { r: 255, g: 255, b: 255 };
        }
        
        function downloadImage() {
            const canvas = document.getElementById('canvas');
            
            // 1. Better iOS detection (includes iPads pretending to be Macs)
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                          (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
            
            // 2. iOS Logic: Try to Share first
            if (isIOS && navigator.share && navigator.canShare) {
                canvas.toBlob(async (blob) => {
                    if (!blob) return;
                    const file = new File([blob], 'quote_' + Date.now() + '.png', { type: 'image/png' });
                    
                    // Verify if the device can actually share this file
                    if (navigator.canShare({ files: [file] })) {
                        try {
                            await navigator.share({ files: [file] });
                            // Success - user sees native sheet
                        } catch (err) {
                            // User cancelled or error
                            if (err.name !== 'AbortError') showToast('저장 중 오류가 발생했습니다.');
                        }
                    } else {
                        // Fallback if sharing is technically supported but this file fails
                        downloadDirectly(canvas); 
                        showToast('이미지가 저장되었습니다.');
                    }
                });
            } else {
                // 3. PC / Android Logic: Direct Download
                downloadDirectly(canvas);
                showToast('이미지가 저장되었습니다.');
            }
        }
        
        function downloadDirectly(canvas) {
            const link = document.createElement('a');
            link.download = 'quote_' + Date.now() + '.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        }
        
        async function copyImage() {
            const canvas = document.getElementById('canvas');
            if (!window.ClipboardItem) {
                showToast('이 브라우저는 복사를 지원하지 않습니다.');
                return;
            }
            try {
                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                if (!blob) return;
                const clipboardItem = new ClipboardItem({ 'image/png': blob });
                await navigator.clipboard.write([clipboardItem]);
                showToast('클립보드에 복사되었습니다.');
            } catch (err) {
                if (err.name === 'NotAllowedError') showToast('복사 권한이 없습니다.');
                else showToast('복사 기능을 사용할 수 없습니다.');
            }
        }
        
        function shareImage() {
            const canvas = document.getElementById('canvas');
            if (navigator.share && navigator.canShare) {
                canvas.toBlob(async (blob) => {
                    const file = new File([blob], 'quote_' + Date.now() + '.png', { type: 'image/png' });
                    if (navigator.canShare({ files: [file] })) {
                        try {
                            await navigator.share({ files: [file] });
                        } catch (err) {}
                    } else {
                        showToast('공유를 지원하지 않습니다.');
                    }
                });
            } else {
                showToast('공유 기능을 지원하지 않습니다.');
            }
        }
        
        // Event Listeners Setup
        function setupEventListeners() {
            document.getElementById('useGradient').addEventListener('change', toggleGradientUI);
            
            ['bgColorMain', 'bgColorSub'].forEach(id => {
                document.getElementById(id).addEventListener('input', updateCanvas);
            });
            
            document.getElementById('textColor').addEventListener('input', (e) => {
                // Removed span update
                updateCanvas();
            });
            
            ['quote', 'author', 'title'].forEach(id => {
                 document.getElementById(id).addEventListener('input', updateCanvas);
            });
            
            ['fontSelect', 'platformSelect', 'canvasRatio'].forEach(id => {
                document.getElementById(id).addEventListener('change', updateCanvas);
            });

            ['fontSize', 'lineHeight', 'padding', 'logoSize', 'bgImageScale'].forEach(id => {
                document.getElementById(id).addEventListener('input', (e) => {
                    // Update the display value span
                    const displayId = id === 'bgImageScale' ? 'scaleValue' : id + 'Value';
                    const el = document.getElementById(displayId);
                    if(el) el.textContent = e.target.value;
                    updateCanvas();
                });
            });

            // Special listener for Overlay Opacity to handle text
            document.getElementById('overlayOpacity').addEventListener('input', (e) => {
                const val = parseInt(e.target.value);
                const displayEl = document.getElementById('overlayValueText');
                if (val === 0) displayEl.textContent = "원본";
                else if (val < 0) displayEl.textContent = `밝게 ${Math.abs(val)}%`;
                else displayEl.textContent = `어둡게 ${val}%`;
                updateCanvas();
            });

            document.querySelectorAll('input[name="align"], input[name="linebreak"], input[name="imageFit"], input[name="imagePosition"]').forEach(radio => {
                radio.addEventListener('change', updateCanvas);
            });
            
            // Paste handlers
            ['quote', 'author', 'title'].forEach(id => {
                document.getElementById(id).addEventListener('paste', function(e) {
                    e.preventDefault();
                    const text = (e.clipboardData || window.clipboardData).getData('text/plain');
                    document.execCommand('insertText', false, text);
                });
            });
        }
        
        (async function init() {
            setupEventListeners();
            await preloadFonts();
            preloadLogos();
            await document.fonts.ready;
            
            // Init default visual state
            document.getElementById('fontSizeValue').textContent = document.getElementById('fontSize').value;
            document.getElementById('lineHeightValue').textContent = document.getElementById('lineHeight').value;
            
            // Ensure UI matches checked state
            toggleGradientUI();
            
            updateCanvas();
        })();

    </script>
</body>
</html>
